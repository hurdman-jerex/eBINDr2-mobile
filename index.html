<?

$page = 'search';
include "templates/header.html";
include "templates/nav-bar.html";
include "templates/search/_container-start.html";

if ($_GET['search'] == 'businessphone') {
    $nav = 2;
    $label = 'Business Phone';
} else if ($_GET['search'] == 'businessid') {
    $nav = 3;
    $label = 'Business ID';
} else if ($_GET['search'] == 'complaintid') {
    $nav = 4;
    $label = 'Complaint ID';
}else if ($_GET['search'] == 'businessemail') {
    $nav = 5;
    $label = 'Business Email';
}else if ($_GET['search'] == 'webaddress') {
    $nav = 6;
    $label = 'Web Address';
}else if ($_GET['search'] == 'employee') {
    $nav = 7;
    $label = 'Employee';
}else if ($_GET['search'] == 'consumername') {
    $nav = 8;
    $label = 'Consumer Name';
} else {
    $nav = 1;
    $label = 'Business Name';
}

if (sizeof($_POST) > 0) {
    if ($_POST['type'] == 'businessid') {
        $url = $myHost . $_SERVER['SERVER_NAME'].'/m/api/search/businessbid/' . $_POST['search'];
        $businesses = json_decode($bbapi->post($url));
        $businesses = $businesses->results;
    } else if ($_POST['type'] == 'businessphone') {
        $digits = preg_replace("/[^0-9,.]*/", "", $_POST['search']);
        $digits = trim($digits);
        $digits = str_replace(' ', '', $digits); //remove spaces
        $url = $myHost . $_SERVER['SERVER_NAME'].'/m/api/search/businessphone/' . $digits;
        $businesses = json_decode($bbapi->post($url));
        $businesses = $businesses->results;
    } else if ($_POST['type'] == 'complaintid') {
        $url = $myHost . $_SERVER['SERVER_NAME'].'/m/api/search/complaintcid/' . $_POST['search'];
        $complaints = json_decode($bbapi->post($url));
        $complaints = $complaints->results;
    }else if ($_POST['type'] == 'businessemail') {
        $url = $myHost . $_SERVER['SERVER_NAME'].'/m/api/search/businessemail/' . $_POST['search'];
        $businesses = json_decode($bbapi->post($url));
        $businesses = $businesses->results;
    }else if ($_POST['type'] == 'webaddress') {
        // in case scheme relative URI is passed, e.g., //www.google.com/
        $input = trim($_POST['search'], '/');
        // If scheme not included, prepend it
        if (!preg_match('#^http(s)?://#', $input))
            $input = 'http://' . $input;
        $urlParts = parse_url($input);
    
        $url = $myHost . $_SERVER['SERVER_NAME'].'/m/api/search/webaddress/' . $urlParts['host'] ;
        $businesses = json_decode($bbapi->post($url));
        $businesses = $businesses->results;
    }else if ($_POST['type'] == 'employee') {
        $url = $myHost . $_SERVER['SERVER_NAME'].'/m/api/search/employee/' . $_POST['search'];
        $businesses = json_decode($bbapi->post($url));
        $businesses = $businesses->results;
    }else if ($_POST['type'] == 'consumername') {
        $url = $myHost . $_SERVER['SERVER_NAME'].'/m/api/search/consumername/' . $_POST['search'];
        $complaints = json_decode($bbapi->post($url));
        $complaints = $complaints->results;
    } else {
        $bname = preg_replace("/[^A-Za-z,.]*/", "", $_POST['search']);
        $_POST['search'] = preg_replace("/[^A-Za-z',.]*/", "", $_POST['search']);
        $url = $myHost . $_SERVER['SERVER_NAME'].'/m/api/search/businessname2/' . $bname;
        $businesses = json_decode($bbapi->post($url));
        $businesses = $businesses->results;
    }
}
//print_r($_SESSION['user']); 
function remove_phone_format($number) {
    $number=trim($number);
    $number=  str_replace('-', '', $number);
    $number= str_replace(' ','',$number);
    return $number;
}

?>
<style type="text/css">
    .rating {
        border: 2px solid #0099cc;
        color: #0099cc;
        -webkit-border-radius: 4px;
        -moz-border-radius: 4px;
        border-radius: 4px;
        padding: 0 5px;
        display: inline-block;
        text-align: center;
        min-width: 20px;
        background-color: #e6e6e6;
        background-image: -webkit-gradient(linear, 0 0, 0 100%, from(#ffffff), to(#e6e6e6));
        background-image: -webkit-linear-gradient(top, #ffffff, #e6e6e6);
        background-image: -o-linear-gradient(top, #ffffff, #e6e6e6);
        background-image: linear-gradient(to bottom, #ffffff, #e6e6e6);
        background-image: -moz-linear-gradient(top, #ffffff, #e6e6e6);
        background-repeat: repeat-x;
    }

    .ab {
        margin: 10px 0;
    }
</style>
<div class="subnav">
    <ul class="nav nav-pills">
        <li class="<?= ($nav == 1 ? 'active' : '') ?>"><a href="index.html">Business Name</a></li>
        <li class="<?= ($nav == 2 ? 'active' : '') ?>"><a href="index.html?search=businessphone">Business Phone</a></li>
        <li class="<?= ($nav == 3 ? 'active' : '') ?>"><a href="index.html?search=businessid">Business ID</a></li>
        <li class="<?= ($nav == 4 ? 'active' : '') ?>"><a href="index.html?search=complaintid">Complaint ID</a></li>
        <li class="<?= ($nav == 5 ? 'active' : '') ?>"><a href="index.html?search=businessemail">Business Email</a></li>
        <li class="<?= ($nav == 6 ? 'active' : '') ?>"><a href="index.html?search=webaddress">Web Address</a></li>
        <li class="<?= ($nav == 7 ? 'active' : '') ?>"><a href="index.html?search=employee">Employee</a></li>
        <li class="<?= ($nav == 8 ? 'active' : '') ?>"><a href="index.html?search=consumername">Consumer Name</a></li>
    </ul>
</div>

<form class="well form-search" method="post" action="" id="searchform" style="margin-top: 10px;" onsubmit="show_loader();">
    <input type="hidden" name="type" value="<?= $_GET['search'] ?>" />
    <div class="input-append">
        <input id="searchbox" class="input-xlarge" type="text" placeholder="<?= $label ?>" name="search" value="<?= (isset($_POST['search']) ? $_POST['search'] : '') ?>"><button type="submit" class="btn"><i class="icon-search"></i> Search</button>
        <span id="loader">&nbsp;&nbsp;<img src="/m/assets/img/159.gif" alt="searching..." height="25"/></span>
    </div>
</form>

<div class="" id="search-result">

    <? if (sizeof($_POST) > 0): ?>
        <table class="table table-bordered table-hover table-striped">
            <tbody>
                <?
                if (sizeof($businesses) > 0 && ( $_GET['search'] != 'complaintid' || $_GET['search'] != 'consumername' ) ) {
                    foreach ($businesses as $business) {
                        if( ! isset( $business->bid ) )
                                continue;
                        ?>
                        <tr>
                            <td>       
                                <address>
                                    <? if ($_GET['search'] == 'businessid') { ?>
                                        <h3>Business ID: <a href="/m/searchlink.html?bid=<?= $business->bid ?>"><?= $business->bid ?></a></h3>                                
                                        <h3><a href="/m/searchlink.html?bid=<?= $business->bid ?>"><?= $business->name ?></a> <div class="rating"><h3><?= $business->Letter ?></h3></div></h3>
                                        <? if ($business->member == 'y'): ?>
                                            <img src="http://<?= $_SERVER['SERVER_NAME'] ?>/m/assets/img/bbb-ab3.png" alt="Accredited Business" height="31" class="ab"/>
                                        <? endif; ?>
                                        <br/>
                                        <?= ($business->street1) . ', ' . ($business->county) ?><br>
                                        <?= $business->city ?>, <?= $business->stateProv ?> <?= $business->postalCode ?><br>
                                        <br>
                                        <p>
                                            <? if (strlen(trim($business->number)) > 1): ?>
                                                <abbr title="Phone Number">Phone: </abbr><a href="tel:<?= $business->number ?>"><?= $business->number ?></a><br/>
                                            <? endif; ?>

                                            <? if ($business->email != '' && $business->email != null): ?>
                                                <abbr title="Email Address">Email: </abbr><a href="mailto:<?= $business->email ?>"><?= $business->email ?></a>
                                            <? endif; ?>
                                        </p>
                                    <? } else if ($_GET['search'] == 'businessphone') { ?>
                                        <h3>
                                            <a href="/m/searchlink.html?bid=<?= $business->bid ?>"><?= $business->name ?></a>
                                            <div class="rating">
                                                <h3><?= $business->Letter ?></h3>
                                            </div>
                                            
                                        </h3>   
                                        <? if ($business->member == 'y'): ?>
                                            <img src="http://<?= $_SERVER['SERVER_NAME'] ?>/m/assets/img/bbb-ab3.png" alt="Accredited Business" height="31" class="ab"/>
                                        <? endif; ?>
                                        <br>
                                        <?= ($business->street1) . ', ' . ($business->county) ?><br>
                                        <?= $business->city ?>, <?= $business->stateProv ?> <?= $business->postalCode ?><br>
                                        <br>
                                        <p>
                                            <? if (strlen(trim($business->number)) > 1): ?>
                                                <abbr title="Phone Number">Phone: </abbr><b><a href="http:///m/searchlink.html?bid=<?= $business->bid ?>"> <?= $business->number ?> </a></b><br/>
                                            <? endif; ?>

                                            <? if ($business->email != '' && $business->email != null): ?>
                                                <abbr title="Email Address">Email: </abbr><a href="mailto:<?= $business->email ?>"><?= $business->email ?></a>
                                            <? endif; ?>
                                        </p>
                                    <? } else if ($_GET['search'] == 'webaddress') { ?>
                                        <h3>
                                            <a href="/m/searchlink.html?bid=<?= $business->bid ?>"><?= $business->name ?></a>
                                            <div class="rating">
                                                <h3><?= $business->Letter ?></h3>
                                            </div>
                                            
                                        </h3>   
                                        <? if ($business->member == 'y'): ?>
                                            <img src="http://<?= $_SERVER['SERVER_NAME'] ?>/m/assets/img/bbb-ab3.png" alt="Accredited Business" height="31" class="ab"/>
                                        <? endif; ?>
                                        <br>
                                        <?= ($business->street1) . ', ' . ($business->county) ?><br>
                                        <?= $business->city ?>, <?= $business->stateProv ?> <?= $business->postalCode ?><br>
                                        <br>
                                        <p>
                                            <? if (strlen(trim($business->number)) > 1): ?>
                                                <abbr title="Phone Number">Phone: </abbr><b><a href="http:///m/searchlink.html?bid=<?= $business->bid ?>"> <?= $business->number ?> </a></b><br/>
                                            <? endif; ?>

                                            <? if ($business->email != '' && $business->email != null): ?>
                                                <abbr title="Email Address">Email: </abbr><a href="mailto:<?= $business->email ?>"><?= $business->email ?></a><br />
                                            <? endif; ?>
                                            
                                            <? if ($business->url != '' && $business->url != null): ?>
                                                <abbr title="Web Address">URL: </abbr><a href="<?= $business->url ?>"><?= $business->url ?></a>
                                            <? endif; ?>
                                        </p>
                                    <? }else if ($_GET['search'] == 'employee' && isset( $business->bid ) ) { ?>
                                        <h3>
                                            <a href="/m/searchlink.html?bid=<?= $business->bid ?>"><?= $business->name ?></a>
                                            <div class="rating">
                                                <h3><?= $business->Letter ?></h3>
                                            </div>
                                            
                                        </h3>   
                                        <? if ($business->member == 'y'): ?>
                                            <img src="http://<?= $_SERVER['SERVER_NAME'] ?>/m/assets/img/bbb-ab3.png" alt="Accredited Business" height="31" class="ab"/>
                                        <? endif; ?>
                                        <br>
                                        <p>
                                            <abbr title="Employee Name">Employee Name: </abbr><b><a href="http:///m/searchlink.html?bid=<?= $business->bid ?>"> <?= $business->employee ?> </a></b><br/>

                                            <? if ($business->Title != '' && $business->Title != null): ?>
                                                <abbr title="Employee Title">Title: </abbr><a href="http:///m/searchlink.html?bid=<?= $business->bid ?>"> <?= $business->Title ?> </a><br />
                                            <? endif; ?>
                                            
                                            <? if ($business->Label != '' && $business->Label != null): ?>
                                                <abbr title="Label">Label: </abbr><a href="http:///m/searchlink.html?bid=<?= $business->bid ?>"> <?= $business->Label ?> </a><br />
                                            <? endif; ?>
                                        </p>
                                    <? } else { ?>                              
                                        <h3>
                                            <a href="/m/searchlink.html?bid=<?= $business->bid ?>"><?= $business->name ?> </a>
                                            <div class="rating"><?= $business->Letter ?></div>
                                        </h3>
                                        <? if ($business->member == 'y'): ?>
                                            <img src="http://<?= $_SERVER['SERVER_NAME'] ?>/m/assets/img/bbb-ab3.png" alt="Accredited Business" height="31" class="ab"/>
                                        <? endif; ?>
                                        <br/>
                                        <?= ($business->street1) . ', ' . ($business->county) ?><br>
                                        <?= $business->city ?>, <?= $business->stateProv ?> <?= $business->postalCode ?><br>
                                        <br>
                                        <p>
                                            <? if (strlen(trim($business->number)) > 1): ?>
                                                <abbr title="Phone Number">Phone: </abbr><a href="tel:<?= remove_phone_format($business->number) ?>"><?= $business->number ?></a><br/>
                                            <? endif; ?>

                                            <? if ($business->email != '' && $business->email != null): ?>
                                                <abbr title="Email Address">Email: </abbr><a href="mailto:<?= $business->email ?>"><?= $business->email ?></a>
                                            <? endif; ?>
                                        </p>
                                    <? } ?>
                                </address>
                            </td>
                        </tr>
                        <?
                    }
                } else if (sizeof($complaints) > 0 && ( $_GET['search'] == 'complaintid' || $_GET['search'] == 'consumername' ) ) {

                    foreach ($complaints as $complaint) {
                        if( ! isset( $complaint->BID ) )
                            continue;
                        ?>
                        <tr>
                            <td>           
                                <address>
                                    <h3>Complaint ID: <a href="/m/searchlink.html?bid=<?= $complaint->BID ?>&cid=<?=$complaint->CID?>"><?= $complaint->CID ?></a></h3>
                                    <br/>
                                    <h3><a href="/m/searchlink.html?bid=<?= $complaint->BID ?>"><?= $complaint->Name ?></a>
                                        <div class="rating">
                                            <h3><?= $complaint->Letter ?></h3>
                                        </div> 
                                    </h3>
                                    <? if ($complaint->member == 'y'): ?>
                                        <img src="http://<?= $_SERVER['SERVER_NAME'] ?>/m/assets/img/bbb-ab3.png" alt="Accredited Business" height="31" class="ab"/>
                                    <? endif; ?>
                                    <br/>
                                    <p> Business ID: <strong><?= $complaint->BID ?></strong><br/>
                                        Cosumer Name: <strong><?= ($complaint->firstname) . ' ' . ($complaint->lastname) ?></strong></p>
                                    <? if (strlen(trim($complaint->number)) > 1): ?>
                                        <p>Phone: <a href="tel:<?= $complaint->number ?>"><?= $complaint->number ?></a></p>
                                    <? endif; ?>
                                </address>
                            </td>
                        </tr>
                    <? } ?>
                <? } else { ?>
                    <tr>
                        <td>
                            <h4>No Results Found</h4>
                        </td>
                    </tr>
                <? } ?>
            </tbody>
        </table>
    <? endif; ?>
</div>
<script type="text/javascript">
    jQuery.noConflict(); 
    jQuery('#loader').fadeOut(100);
    jQuery('#search-result').hide().fadeIn(1000);
    function show_loader(){
        jQuery('#loader').fadeIn(300);
    }
    
    jQuery(document).ready(function(e) {
        jQuery('.force_update').click( function(e) {
        });
    });    
</script>
<? include "templates/search/_container-end.html"; ?>  
<? include "templates/footer.html"; ?>
